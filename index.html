<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Practice Player</title>

  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
    .card{background:white;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);max-width:560px;margin:0 auto;}
    input[type=range]{width:100%;}
    button{padding:10px 16px;margin:6px;font-size:15px;}
    .big{font-size:18px;font-weight:bold;}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
    .hint{font-size:12px;color:#555;line-height:1.4;}
  </style>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ ç·´ç¿’ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
    </div>
    <p class="hint">
      â€» iPhoneã¯ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†ç”Ÿã™ã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚<br>
      â€» iPhoneã®ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ (PWA)ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®æ™‚ã¯Safariã§é–‹ã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚
    </p>

    <audio id="audio" controls playsinline></audio>

    <h3>å†ç”Ÿé€Ÿåº¦ï¼ˆãƒ”ãƒƒãƒç¶­æŒï¼‰</h3>
    <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1" />
    <p class="big" id="speedValue">1.00x</p>

    <h3>A-Bãƒ«ãƒ¼ãƒ—</h3>
    <div class="row">
      <button id="setABtn">Aè¨­å®š</button>
      <button id="setBBtn">Bè¨­å®š</button>
      <button id="clearLoopBtn">è§£é™¤</button>
    </div>
    <p id="loopStatus">æœªè¨­å®š</p>

    <h3>10ç§’æˆ»ã‚‹ / é€²ã‚€</h3>
    <div class="row">
      <button id="back10">â—€ 10ç§’</button>
      <button id="fwd10">10ç§’ â–¶</button>
    </div>
  </div>

  <script>
    const audio = document.getElementById('audio');
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');

    const speed = document.getElementById('speed');
    const speedValue = document.getElementById('speedValue');

    const loopStatus = document.getElementById('loopStatus');
    const setABtn = document.getElementById('setABtn');
    const setBBtn = document.getElementById('setBBtn');
    const clearLoopBtn = document.getElementById('clearLoopBtn');

    const back10 = document.getElementById('back10');
    const fwd10 = document.getElementById('fwd10');

    let A = null;
    let B = null;
    let blobUrl = null;

    function setPreservePitch() {
      // ãƒ–ãƒ©ã‚¦ã‚¶å·®ç•°å¸åï¼ˆåŠ¹ã‹ãªã„ç’°å¢ƒã‚‚ã‚ã‚‹ãŒå®³ã¯ãªã„ï¼‰
      audio.preservesPitch = true;
      audio.webkitPreservesPitch = true;
    }

    function loadSelectedFile() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
      }
      if (blobUrl) URL.revokeObjectURL(blobUrl);
      blobUrl = URL.createObjectURL(f);
      audio.src = blobUrl;
      audio.load();
      setPreservePitch();
      // iOS/Safariã¯è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã®ã§ã“ã“ã§ã¯å†ç”Ÿã—ãªã„
    }

    loadBtn.addEventListener('click', loadSelectedFile);

    fileInput.addEventListener('change', () => {
      // é¸ã³ç›´ã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—è§£é™¤
      loopStatus.innerText = 'æœªè¨­å®š';
      A = null; B = null;
    });

    speed.addEventListener('input', () => {
      audio.playbackRate = Number(speed.value);
      setPreservePitch();
      speedValue.innerText = Number(speed.value).toFixed(2) + 'x';
    });

    setABtn.addEventListener('click', () => {
      if (!audio.src) { alert('å…ˆã«ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
      A = audio.currentTime;
      loopStatus.innerText = 'A:' + A.toFixed(1);
    });

    setBBtn.addEventListener('click', () => {
      if (!audio.src) { alert('å…ˆã«ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
      if (A === null) { alert('å…ˆã«Aã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
      B = audio.currentTime;
      if (B <= A) {
        alert('Bã¯Aã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
        B = null;
        loopStatus.innerText = 'A:' + A.toFixed(1);
        return;
      }
      loopStatus.innerText = 'A:' + A.toFixed(1) + ' / B:' + B.toFixed(1);
    });

    clearLoopBtn.addEventListener('click', () => {
      A = null; B = null;
      loopStatus.innerText = 'æœªè¨­å®š';
    });

    function skip(sec) {
      if (!audio.duration || isNaN(audio.duration)) return;
      audio.currentTime = Math.min(Math.max(0, audio.currentTime + sec), audio.duration);
    }

    back10.addEventListener('click', () => skip(-10));
    fwd10.addEventListener('click', () => skip(10));

    audio.addEventListener('timeupdate', () => {
      if (A !== null && B !== null && audio.currentTime >= B) {
        audio.currentTime = A;
      }
    });

    // åˆæœŸè¡¨ç¤º
    speedValue.innerText = Number(speed.value).toFixed(2) + 'x';
  </script>
</body>
</html>
