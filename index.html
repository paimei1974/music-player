<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pitch Player</title>
  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);max-width:560px;margin:0 auto;}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;align-items:center;}
    input[type=range]{width:100%;}
    button{padding:10px 16px;margin:6px;font-size:15px;}
    .big{font-size:18px;font-weight:bold;}
    .hint{font-size:12px;color:#555;line-height:1.4;margin-top:8px;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>

  <!-- Tone.js (CDN) -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ åŠéŸ³ãƒ”ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
      <button id="playBtn">å†ç”Ÿ</button>
      <button id="pauseBtn">åœæ­¢</button>
    </div>

    <p class="hint">
      â€» iPhoneã¯ <b>ã€Œèª­ã¿è¾¼ã¿ã€â†’ã€Œå†ç”Ÿã€</b> ã®é †ãŒå®‰å®šã—ã¾ã™ã€‚<br>
      â€» éŸ³ãŒäºŒé‡ã«èã“ãˆã‚‹æ™‚ã¯ã€ä¸‹ã®éŸ³é‡ã‚’ 0 ã«ã—ã¦ã„ã¾ã™ï¼ˆå‡¦ç†å¾Œã®éŸ³ã ã‘å‡ºã—ã¾ã™ï¼‰ã€‚
    </p>

    <!-- audioè¦ç´ ã¯ã€Œåˆ¶å¾¡ç”¨ã€ï¼ˆå®ŸéŸ³ã¯WebAudioå´ã‹ã‚‰å‡ºã™ï¼‰ -->
    <audio id="audio" controls playsinline class="mono" style="width:100%; margin-top:10px;"></audio>

    <h3>ãƒ”ãƒƒãƒï¼ˆåŠéŸ³ï¼‰</h3>
    <input type="range" id="pitch" min="-12" max="12" step="1" value="0" />
    <p class="big"><span id="pitchValue">0</span>ï¼ˆåŠéŸ³ï¼‰</p>
  </div>

  <script>
    const audioEl = document.getElementById('audio');
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    const pitch = document.getElementById('pitch');
    const pitchValue = document.getElementById('pitchValue');

    let blobUrl = null;

    // Tone.js nodes
    let mediaSource = null;
    let pitchShift = null;
    let ready = false;

    async function ensureAudioGraph() {
      if (ready) return;

      // iOSå¯¾ç­–ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ã«AudioContexté–‹å§‹
      await Tone.start();

      // audioè¦ç´  â†’ WebAudio(Tone) ã¸å–ã‚Šè¾¼ã¿
      mediaSource = Tone.context.createMediaElementSource(audioEl);

      pitchShift = new Tone.PitchShift({
        pitch: Number(pitch.value), // åŠéŸ³
        windowSize: 0.1
      });

      // ã¤ãªãï¼šmediaSource -> pitchShift -> destination
      mediaSource.connect(pitchShift);
      pitchShift.toDestination();

      // å…ƒã®audioå‡ºåŠ›ã¯ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆå‡¦ç†å¾Œã ã‘é³´ã‚‰ã™ï¼‰
      audioEl.volume = 0;

      ready = true;
    }

    function loadSelectedFile() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
      }
      if (blobUrl) URL.revokeObjectURL(blobUrl);
      blobUrl = URL.createObjectURL(f);
      audioEl.src = blobUrl;
      audioEl.load();
    }

    loadBtn.addEventListener('click', async () => {
      loadSelectedFile();
      await ensureAudioGraph();
      // iOSã¯è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯å†ç”Ÿã—ãªã„
    });

    playBtn.addEventListener('click', async () => {
      await ensureAudioGraph();
      if (!audioEl.src) {
        alert('å…ˆã«ã€Œèª­ã¿è¾¼ã¿ã€ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        return;
      }
      await audioEl.play();
    });

    pauseBtn.addEventListener('click', () => {
      audioEl.pause();
    });

    pitch.addEventListener('input', async () => {
      pitchValue.textContent = pitch.value;
      if (pitchShift) pitchShift.pitch = Number(pitch.value);
    });

    // åˆæœŸè¡¨ç¤º
    pitchValue.textContent = pitch.value;
  </script>
</body>
</html>

