<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Practice Player</title>

  <style>
    :root { --bg:#f5f6fa; --card:#fff; --text:#111; --muted:#555; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;text-align:center;margin:0;padding:18px;background:var(--bg);color:var(--text);}
    .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,0.10);max-width:620px;margin:0 auto;}
    h2{margin:6px 0 10px;}
    h3{margin:18px 0 10px;font-size:16px;}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;}
    .row > *{flex:0 0 auto;}
    input[type="file"]{max-width:100%;}
    input[type="range"]{width:100%;}
    button{padding:10px 14px;margin:0;border:0;border-radius:12px;background:#111;color:#fff;font-size:15px;cursor:pointer;}
    button.secondary{background:#e9eaee;color:#111;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .big{font-size:18px;font-weight:700;margin:8px 0;}
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin:10px 0 0;}
    .status{font-size:13px;color:var(--muted);line-height:1.45;margin:10px 0 0;white-space:pre-line;}
    .sep{height:1px;background:#ececf1;margin:16px 0;}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef0f6;font-size:12px;color:#333;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
  </style>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ ç·´ç¿’ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
    </div>

    <p class="hint">
      â€» iPhoneã¯<strong>ã€Œèª­ã¿è¾¼ã¿ã€â†’ã€Œå†ç”Ÿã€</strong>ã®é †ãŒä¸€ç•ªå®‰å®šã—ã¾ã™ã€‚<br>
      â€» ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ (PWA)ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒå‹•ã‹ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯Safariã§é–‹ã„ã¦ãã ã•ã„ã€‚
    </p>

    <div class="sep"></div>

    <div class="row" style="justify-content:space-between;gap:12px;">
      <span class="pill">çŠ¶æ…‹: <span id="stateText" class="mono">æœªèª­ã¿è¾¼ã¿</span></span>
      <span class="pill">ç¾åœ¨: <span id="timeText" class="mono">0.0</span>s</span>
    </div>

    <audio id="audio" controls playsinline preload="metadata" style="width:100%;margin-top:10px;"></audio>

    <div class="row" style="margin-top:10px;">
      <button id="playBtn">â–¶ å†ç”Ÿ</button>
      <button id="pauseBtn" class="secondary">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="stopBtn" class="secondary">â¹ åœæ­¢</button>
    </div>

    <h3>å†ç”Ÿé€Ÿåº¦ï¼ˆãƒ”ãƒƒãƒç¶­æŒï¼‰</h3>
    <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1" />
    <p class="big" id="speedValue">1.00x</p>

    <h3>A-Bãƒ«ãƒ¼ãƒ—</h3>
    <div class="row">
      <button id="setABtn" class="secondary">Aè¨­å®š</button>
      <button id="setBBtn" class="secondary">Bè¨­å®š</button>
      <button id="clearLoopBtn" class="secondary">è§£é™¤</button>
    </div>
    <p id="loopStatus" class="mono">æœªè¨­å®š</p>

    <h3>10ç§’æˆ»ã‚‹ / é€²ã‚€</h3>
    <div class="row">
      <button id="back10" class="secondary">â—€ 10ç§’</button>
      <button id="fwd10" class="secondary">10ç§’ â–¶</button>
    </div>

    <p id="msg" class="status"></p>
  </div>

  <script>
    const audio = document.getElementById('audio');
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');

    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');

    const speed = document.getElementById('speed');
    const speedValue = document.getElementById('speedValue');

    const setABtn = document.getElementById('setABtn');
    const setBBtn = document.getElementById('setBBtn');
    const clearLoopBtn = document.getElementById('clearLoopBtn');
    const loopStatus = document.getElementById('loopStatus');

    const back10 = document.getElementById('back10');
    const fwd10 = document.getElementById('fwd10');

    const msg = document.getElementById('msg');
    const stateText = document.getElementById('stateText');
    const timeText = document.getElementById('timeText');

    let A = null;
    let B = null;
    let blobUrl = null;

    // ãƒ«ãƒ¼ãƒ—ç›£è¦–ï¼ˆtimeupdateãŒè’ã„ç’°å¢ƒã®ä¿é™ºï¼‰
    let loopTimer = null;

    function log(s) {
      msg.textContent = s;
    }

    function setState(s) {
      stateText.textContent = s;
    }

    function setPreservePitch() {
      // ãƒ–ãƒ©ã‚¦ã‚¶å·®ç•°å¸å
      try { audio.preservesPitch = true; } catch(e) {}
      try { audio.webkitPreservesPitch = true; } catch(e) {}
      try { audio.mozPreservesPitch = true; } catch(e) {}
    }

    function clampTime(t) {
      if (Number.isNaN(t) || !Number.isFinite(t)) return 0;
      if (t < 0) return 0;
      const d = audio.duration;
      if (Number.isFinite(d) && d > 0 && t > d) return d;
      return t;
    }

    function clearLoop() {
      A = null; B = null;
      loopStatus.textContent = 'æœªè¨­å®š';
    }

    function updateLoopStatus() {
      if (A === null && B === null) {
        loopStatus.textContent = 'æœªè¨­å®š';
        return;
      }
      if (A !== null && B === null) {
        loopStatus.textContent = `A:${A.toFixed(1)} / B:æœªè¨­å®š`;
        return;
      }
      loopStatus.textContent = `A:${A.toFixed(1)} / B:${B.toFixed(1)}`;
    }

    function stopLoopTimer() {
      if (loopTimer) {
        clearInterval(loopTimer);
        loopTimer = null;
      }
    }

    function startLoopTimer() {
      stopLoopTimer();
      loopTimer = setInterval(() => {
        if (A !== null && B !== null && !audio.paused) {
          if (audio.currentTime >= B) {
            audio.currentTime = A;
          }
        }
      }, 60);
    }

    function hasLoaded() {
      return !!audio.src;
    }

    function loadSelectedFile() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
      }

      // æ—¢å­˜blob URLè§£æ”¾
      if (blobUrl) URL.revokeObjectURL(blobUrl);
      blobUrl = URL.createObjectURL(f);

      // çŠ¶æ…‹åˆæœŸåŒ–
      clearLoop();
      stopLoopTimer();

      audio.pause();
      audio.currentTime = 0;
      audio.src = blobUrl;

      // iOSå¯¾ç­–: load() ã‚’æ˜ç¤º
      audio.load();

      setPreservePitch();
      audio.playbackRate = Number(speed.value);

      setState('èª­ã¿è¾¼ã¿æ¸ˆã¿ï¼ˆå†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰');
      log('èª­ã¿è¾¼ã¿å®Œäº†ã€‚â–¶ å†ç”Ÿ ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    }

    async function safePlay() {
      if (!hasLoaded()) {
        alert('å…ˆã«éŸ³æºã‚’ã€Œèª­ã¿è¾¼ã¿ã€ã—ã¦ãã ã•ã„');
        return;
      }
      try {
        setPreservePitch();
        audio.playbackRate = Number(speed.value);

        // iOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…ã§ play() ã‚’å‘¼ã¶ã®ãŒé‡è¦
        const p = audio.play();
        if (p && typeof p.then === 'function') await p;

        setState('å†ç”Ÿä¸­');
        log('');
        startLoopTimer();
      } catch (e) {
        // ã‚ˆãã‚ã‚‹: NotAllowedError / AbortError ãªã©
        setState('å†ç”Ÿå¤±æ•—');
        log('å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ»ã‚‚ã†ä¸€åº¦ã€Œâ–¶ å†ç”Ÿã€ã‚’æŠ¼ã™\nãƒ»éŸ³é‡ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤\nãƒ»Safariã§é–‹ã(PWAä¸å¯ã®å ´åˆã‚ã‚Š)\nã‚¨ãƒ©ãƒ¼: ' + (e && e.name ? e.name : e));
      }
    }

    function pause() {
      audio.pause();
      setState('ä¸€æ™‚åœæ­¢');
      stopLoopTimer();
    }

    function stop() {
      audio.pause();
      audio.currentTime = 0;
      setState('åœæ­¢');
      stopLoopTimer();
    }

    function skip(sec) {
      if (!hasLoaded()) return;
      const next = clampTime(audio.currentTime + sec);
      audio.currentTime = next;
    }

    // UIã‚¤ãƒ™ãƒ³ãƒˆ
    loadBtn.addEventListener('click', loadSelectedFile);

    playBtn.addEventListener('click', safePlay);
    pauseBtn.addEventListener('click', pause);
    stopBtn.addEventListener('click', stop);

    speed.addEventListener('input', () => {
      const v = Number(speed.value);
      speedValue.textContent = v.toFixed(2) + 'x';
      audio.playbackRate = v;
      setPreservePitch();
    });

    setABtn.addEventListener('click', () => {
      if (!hasLoaded()) { alert('å…ˆã«éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
      A = audio.currentTime;
      // Aã‚’ç½®ã„ãŸã‚‰Bã¯ä¸€æ—¦ç„¡åŠ¹åŒ–ï¼ˆèª¤ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
      B = null;
      updateLoopStatus();
    });

    setBBtn.addEventListener('click', () => {
      if (!hasLoaded()) { alert('å…ˆã«éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
      if (A === null) { alert('å…ˆã«Aã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }

      const candidate = audio.currentTime;
      if (candidate <= A + 0.05) {
        alert('Bã¯Aã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }
      B = candidate;
      updateLoopStatus();
      startLoopTimer();
    });

    clearLoopBtn.addEventListener('click', () => {
      clearLoop();
      stopLoopTimer();
    });

    back10.addEventListener('click', () => skip(-10));
    fwd10.addEventListener('click', () => skip(10));

    // å†ç”Ÿä½ç½®è¡¨ç¤º
    audio.addEventListener('timeupdate', () => {
      timeText.textContent = (audio.currentTime || 0).toFixed(1);
      if (A !== null && B !== null && audio.currentTime >= B) {
        audio.currentTime = A;
      }
    });

    audio.addEventListener('ended', () => {
      setState('çµ‚äº†');
      stopLoopTimer();
    });

    audio.addEventListener('pause', () => {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒaudioæ¨™æº–UIã§æ­¢ã‚ãŸå ´åˆã‚‚åŒæœŸ
      if (audio.currentTime > 0 && audio.currentTime < (audio.duration || Infinity)) {
        setState('ä¸€æ™‚åœæ­¢');
      }
      stopLoopTimer();
    });

    audio.addEventListener('play', () => {
      setState('å†ç”Ÿä¸­');
      startLoopTimer();
    });

    // åˆæœŸè¡¨ç¤º
    speedValue.textContent = Number(speed.value).toFixed(2) + 'x';
    setPreservePitch();
    setState('æœªèª­ã¿è¾¼ã¿');
    log('éŸ³æºã‚’é¸ã‚“ã§ã€Œèª­ã¿è¾¼ã¿ã€â†’ã€Œâ–¶ å†ç”Ÿã€ã§é–‹å§‹ã—ã¾ã™ã€‚');
  </script>
</body>
</html>
