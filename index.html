<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Practice Player</title>

  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
    .card{background:white;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);max-width:760px;margin:0 auto;}
    input[type=range]{width:100%;}
    button{padding:10px 16px;margin:6px;font-size:15px;}
    .big{font-size:18px;font-weight:bold;}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;align-items:center;}
    .hint{font-size:12px;color:#555;line-height:1.5;text-align:left;margin:10px auto 0;max-width:700px;}
    .sep{height:1px;background:#eee;margin:14px 0;}
    .status{font-size:13px;color:#333;margin-top:6px;}
    .danger{color:#b00020;}
    .pill{display:inline-block;padding:2px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;background:#fafafa;}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;max-width:700px;margin:0 auto;}
    @media(min-width:700px){
      .grid{grid-template-columns:1fr 1fr;}
    }
  </style>

  <!-- SoundTouchJSï¼ˆãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆï¼‰ -->
  <script src="https://unpkg.com/soundtouchjs@0.1.30/dist/soundtouch.min.js"></script>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ ç·´ç¿’ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚­ãƒ¼ä¸Šä¸‹å¯¾å¿œï¼‰</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
      <button id="playBtn">å†ç”Ÿ</button>
      <button id="pauseBtn">åœæ­¢</button>
    </div>

    <div class="hint">
      <div>
        <span class="pill">iPhone Safariå¯¾ç­–</span>
        ã€Œèª­ã¿è¾¼ã¿ã€â†’ã€Œå†ç”Ÿã€ã®é †ã§æŠ¼ã™ã¨å®‰å®šã—ã¾ã™ã€‚<br>
        â€» ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ (PWA)ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®æ™‚ã¯Safariã§é–‹ã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <button id="back10">â—€ 10ç§’</button>
      <button id="back5">â—€ 5ç§’</button>
      <button id="fwd5">5ç§’ â–¶</button>
      <button id="fwd10">10ç§’ â–¶</button>
    </div>

    <div class="row" style="max-width:700px;margin:0 auto;">
      <input type="range" id="seek" min="0" max="1000" value="0" />
    </div>
    <div class="status" id="timeLabel">00:00 / 00:00</div>

    <div class="sep"></div>

    <div class="grid">
      <div>
        <h3>ãƒ†ãƒ³ãƒï¼ˆé€Ÿåº¦ï¼‰</h3>
        <input type="range" id="tempo" min="0.5" max="1.5" step="0.01" value="1" />
        <p class="big" id="tempoValue">1.00x</p>
      </div>

      <div>
        <h3>ã‚­ãƒ¼ï¼ˆéŸ³ç¨‹ï¼šåŠéŸ³ï¼‰</h3>
        <input type="range" id="pitch" min="-12" max="12" step="1" value="0" />
        <p class="big" id="pitchValue">Â±0</p>
        <div class="row">
          <button id="pitchDown">-1</button>
          <button id="pitchZero">0</button>
          <button id="pitchUp">+1</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <h3>A-Bãƒ«ãƒ¼ãƒ—</h3>
    <div class="row">
      <button id="setABtn">Aè¨­å®š</button>
      <button id="setBBtn">Bè¨­å®š</button>
      <button id="toggleLoopBtn">ãƒ«ãƒ¼ãƒ—ON/OFF</button>
      <button id="clearLoopBtn">è§£é™¤</button>
    </div>
    <p class="status" id="loopStatus">æœªè¨­å®š</p>
  </div>

  <script>
    // ========= UI =========
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    const seek = document.getElementById('seek');
    const timeLabel = document.getElementById('timeLabel');

    const tempo = document.getElementById('tempo');
    const tempoValue = document.getElementById('tempoValue');

    const pitch = document.getElementById('pitch');
    const pitchValue = document.getElementById('pitchValue');
    const pitchDown = document.getElementById('pitchDown');
    const pitchUp = document.getElementById('pitchUp');
    const pitchZero = document.getElementById('pitchZero');

    const loopStatus = document.getElementById('loopStatus');
    const setABtn = document.getElementById('setABtn');
    const setBBtn = document.getElementById('setBBtn');
    const toggleLoopBtn = document.getElementById('toggleLoopBtn');
    const clearLoopBtn = document.getElementById('clearLoopBtn');

    const back10 = document.getElementById('back10');
    const back5 = document.getElementById('back5');
    const fwd5 = document.getElementById('fwd5');
    const fwd10 = document.getElementById('fwd10');

    // ========= Audio / SoundTouch =========
    let ctx = null;
    let buffer = null;            // AudioBuffer
    let st = null;                // SoundTouch instance
    let filter = null;            // SimpleFilter
    let node = null;              // ScriptProcessorNode

    let isPlaying = false;
    let startWallTime = 0;        // å†ç”Ÿé–‹å§‹æ™‚åˆ»ï¼ˆctx.currentTimeï¼‰
    let startSamplePos = 0;       // å†ç”Ÿé–‹å§‹æ™‚ã®ã‚µãƒ³ãƒ—ãƒ«ä½ç½®ï¼ˆå…ƒéŸ³æºåŸºæº–ï¼‰
    let samplePos = 0;            // ç¾åœ¨ã‚µãƒ³ãƒ—ãƒ«ä½ç½®ï¼ˆå…ƒéŸ³æºåŸºæº–ï¼‰
    let durationSec = 0;
    let rafId = null;

    // AB loop
    let A = null; // sec
    let B = null; // sec
    let loopEnabled = true;

    // ScriptProcessor ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºï¼ˆå°ã•ã™ãã‚‹ã¨è² è·/é€”åˆ‡ã‚Œã€å¤§ãã™ãã‚‹ã¨é…å»¶ï¼‰
    const PROCESSOR_SIZE = 2048;

    function ensureContext() {
      if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function formatTime(sec) {
      if (!Number.isFinite(sec) || sec < 0) sec = 0;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function updateTempoUI() {
      tempoValue.textContent = Number(tempo.value).toFixed(2) + 'x';
    }
    function updatePitchUI() {
      const v = Number(pitch.value);
      pitchValue.textContent = (v === 0) ? 'Â±0' : (v > 0 ? `+${v}` : `${v}`);
    }

    function updateLoopStatus() {
      if (A === null && B === null) {
        loopStatus.textContent = 'æœªè¨­å®š';
        loopStatus.className = 'status';
        return;
      }
      const parts = [];
      if (A !== null) parts.push('A:' + A.toFixed(1));
      if (B !== null) parts.push('B:' + B.toFixed(1));
      parts.push(loopEnabled ? 'ï¼ˆãƒ«ãƒ¼ãƒ—ONï¼‰' : 'ï¼ˆãƒ«ãƒ¼ãƒ—OFFï¼‰');
      loopStatus.textContent = parts.join(' / ');
      loopStatus.className = 'status';
      if (A !== null && B !== null && B <= A) loopStatus.classList.add('danger');
    }

    function secToSample(sec) {
      if (!buffer) return 0;
      return Math.max(0, Math.min(buffer.length, Math.floor(sec * buffer.sampleRate)));
    }
    function sampleToSec(sample) {
      if (!buffer) return 0;
      return sample / buffer.sampleRate;
    }

    function stopEngine() {
      isPlaying = false;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;

      if (node) {
        try { node.disconnect(); } catch(e) {}
        node.onaudioprocess = null;
        node = null;
      }
      filter = null;
    }

    function rebuildEngineFrom(sampleStart) {
      // SoundTouch ã®ã‚½ãƒ¼ã‚¹ã¯ â€œå…ƒãƒãƒƒãƒ•ã‚¡â€ ã‚’èª­ã‚€
      const source = new window.soundtouch.BufferSource(buffer);
      source._position = sampleStart; // å†…éƒ¨ä½ç½®ï¼ˆå®Ÿè£…ä¾å­˜ã ã‘ã© SoundTouchJS ã¯ã“ã‚Œã§å‹•ãã“ã¨ãŒå¤šã„ï¼‰

      st = new window.soundtouch.SoundTouch(buffer.sampleRate);
      st.tempo = Number(tempo.value);                // ãƒ†ãƒ³ãƒï¼ˆé€Ÿåº¦ï¼‰
      st.pitchSemitones = Number(pitch.value);       // ãƒ”ãƒƒãƒï¼ˆåŠéŸ³ï¼‰

      filter = new window.soundtouch.SimpleFilter(source, st);

      node = ctx.createScriptProcessor(PROCESSOR_SIZE, 2, 2);
      node.onaudioprocess = (e) => {
        const outL = e.outputBuffer.getChannelData(0);
        const outR = e.outputBuffer.getChannelData(1);

        // SoundTouch ã‹ã‚‰ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—
        const frames = filter.extract(outL, outL.length);
        if (frames === 0) {
          // çµ‚ç«¯
          stopEngine();
          return;
        }
        // outR ã«ã‚‚ã‚³ãƒ”ãƒ¼ï¼ˆã‚¹ãƒ†ãƒ¬ã‚ªç´ æã¯ SoundTouchJS å´ãŒå¯¾å¿œã—ãã‚Œãªã„å ´åˆãŒã‚ã‚‹ã®ã§ç°¡æ˜“å¯¾å¿œï¼‰
        outR.set(outL);

        // samplePos ã‚’â€œã ã„ãŸã„â€é€²ã‚ã‚‹ï¼ˆãƒ†ãƒ³ãƒå¤‰åŒ–ãŒã‚ã‚‹ã®ã§å³å¯†ã§ã¯ãªã„ãŒUIç”¨é€”ãªã‚‰ååˆ†ï¼‰
        samplePos = source._position || samplePos + frames;

        // ABãƒ«ãƒ¼ãƒ—ï¼ˆsecã§åˆ¤å®šâ†’ã‚µãƒ³ãƒ—ãƒ«ã«æˆ»ã™ï¼‰
        if (loopEnabled && A !== null && B !== null && B > A) {
          const curSec = sampleToSec(samplePos);
          if (curSec >= B) {
            const aS = secToSample(A);
            source._position = aS;
            samplePos = aS;
          }
        }
      };

      node.connect(ctx.destination);
    }

    async function loadSelectedFile() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
      }

      ensureContext();
      // iOS Safari: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…ã§ resume ã™ã‚‹ã¨å®‰å®š
      await ctx.resume();

      const arrayBuf = await f.arrayBuffer();
      buffer = await ctx.decodeAudioData(arrayBuf);
      durationSec = buffer.duration;

      // ä½ç½®ãƒªã‚»ãƒƒãƒˆ
      stopEngine();
      samplePos = 0;
      startSamplePos = 0;
      startWallTime = 0;

      // ãƒ«ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆ
      A = null; B = null; loopEnabled = true;
      updateLoopStatus();

      // UIåæ˜ 
      seek.value = 0;
      timeLabel.textContent = `${formatTime(0)} / ${formatTime(durationSec)}`;

      alert('èª­ã¿è¾¼ã¿å®Œäº†ï¼ã€Œå†ç”Ÿã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');
    }

    async function playFromCurrent() {
      if (!buffer) {
        alert('å…ˆã«ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        return;
      }
      ensureContext();
      await ctx.resume();

      // ã™ã§ã«å†ç”Ÿä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
      if (isPlaying) return;

      // ã‚¨ãƒ³ã‚¸ãƒ³å†æ§‹ç¯‰ã—ã¦å†ç”Ÿ
      rebuildEngineFrom(samplePos);
      isPlaying = true;
      startWallTime = ctx.currentTime;
      startSamplePos = samplePos;

      tickUI();
    }

    function pause() {
      stopEngine();
    }

    function skip(sec) {
      if (!buffer) return;
      const cur = sampleToSec(samplePos);
      let next = cur + sec;
      next = Math.max(0, Math.min(durationSec, next));
      samplePos = secToSample(next);

      // å†ç”Ÿä¸­ãªã‚‰å†æ§‹ç¯‰ï¼ˆSoundTouchã¯ã‚·ãƒ¼ã‚¯ãŒå¼±ã„ã®ã§ä½œã‚Šç›´ã™ã®ãŒç¢ºå®Ÿï¼‰
      if (isPlaying) {
        stopEngine();
        playFromCurrent();
      } else {
        // UIæ›´æ–°ã ã‘
        updateSeekUI();
      }
    }

    function updateSeekUI() {
      const curSec = sampleToSec(samplePos);
      const ratio = durationSec ? (curSec / durationSec) : 0;
      seek.value = Math.round(ratio * 1000);
      timeLabel.textContent = `${formatTime(curSec)} / ${formatTime(durationSec)}`;
    }

    function tickUI() {
      if (!buffer) return;

      // å†ç”Ÿä¸­ã¯ â€œãŠãŠã‚ˆãâ€ ã§æ™‚é–“ã‚’é€²ã‚ã‚‹ï¼ˆç²¾å¯†åŒæœŸã¯é›£ã—ã„ï¼‰
      if (isPlaying) {
        // ãƒ†ãƒ³ãƒã‚’è€ƒæ…®ã—ã¦ã–ã£ãã‚Šé€²ã‚ã‚‹
        const elapsed = ctx.currentTime - startWallTime;
        const approxSec = sampleToSec(startSamplePos) + elapsed * Number(tempo.value);
        const clamped = Math.min(Math.max(0, approxSec), durationSec);
        samplePos = secToSample(clamped);
      }

      updateSeekUI();
      rafId = requestAnimationFrame(tickUI);
    }

    function applyTempoPitchLive() {
      // å†ç”Ÿä¸­ã«å¤‰ãˆã¦ã‚‚åæ˜ ã•ã‚Œã«ãã„ã®ã§ã€å†ç”Ÿä¸­ã¯ä½œã‚Šç›´ã™
      if (isPlaying) {
        stopEngine();
        playFromCurrent();
      }
    }

    // ========= Events =========
    loadBtn.addEventListener('click', loadSelectedFile);
    playBtn.addEventListener('click', playFromCurrent);
    pauseBtn.addEventListener('click', pause);

    back10.addEventListener('click', () => skip(-10));
    back5.addEventListener('click', () => skip(-5));
    fwd5.addEventListener('click', () => skip(5));
    fwd10.addEventListener('click', () => skip(10));

    seek.addEventListener('input', () => {
      if (!buffer) return;
      const ratio = Number(seek.value) / 1000;
      const targetSec = ratio * durationSec;
      samplePos = secToSample(targetSec);
      updateSeekUI();
    });
    seek.addEventListener('change', () => {
      // æŒ‡ã‚’é›¢ã—ãŸã‚‰åæ˜ ï¼ˆå†ç”Ÿä¸­ãªã‚‰å†æ§‹ç¯‰ï¼‰
      if (isPlaying) {
        stopEngine();
        playFromCurrent();
      }
    });

    tempo.addEventListener('input', () => {
      updateTempoUI();
      applyTempoPitchLive();
    });

    pitch.addEventListener('input', () => {
      updatePitchUI();
      applyTempoPitchLive();
    });

    pitchDown.addEventListener('click', () => {
      pitch.value = Math.max(-12, Number(pitch.value) - 1);
      updatePitchUI();
      applyTempoPitchLive();
    });
    pitchUp.addEventListener('click', () => {
      pitch.value = Math.min(12, Number(pitch.value) + 1);
      updatePitchUI();
      applyTempoPitchLive();
    });
    pitchZero.addEventListener('click', () => {
      pitch.value = 0;
      updatePitchUI();
      applyTempoPitchLive();
    });

    setABtn.addEventListener('click', () => {
      if (!buffer) return;
      A = sampleToSec(samplePos);
      if (B !== null && B <= A) B = null;
      updateLoopStatus();
    });
    setBBtn.addEventListener('click', () => {
      if (!buffer) return;
      if (A === null) { alert('å…ˆã«Aã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
      B = sampleToSec(samplePos);
      if (B <= A) { alert('Bã¯Aã‚ˆã‚Šå¾Œã‚ã«è¨­å®šã—ã¦ãã ã•ã„'); B = null; }
      updateLoopStatus();
    });
    toggleLoopBtn.addEventListener('click', () => {
      loopEnabled = !loopEnabled;
      updateLoopStatus();
    });
    clearLoopBtn.addEventListener('click', () => {
      A = null; B = null; loopEnabled = true;
      updateLoopStatus();
    });

    // init UI
    updateTempoUI();
    updatePitchUI();
    updateLoopStatus();
  </script>
</body>
</html>
