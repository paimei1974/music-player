<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Key Practice Player</title>

  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.1);max-width:560px;margin:0 auto;}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;}
    button{padding:10px 16px;font-size:15px;cursor:pointer;}
    input[type=range]{width:100%;}
    .big{font-size:18px;font-weight:bold;margin:6px 0;}
    .hint{font-size:12px;color:#555;line-height:1.4;margin-top:8px;}
    .disabled{opacity:.5;pointer-events:none;}
  </style>

  <!-- Tone.jsï¼ˆãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
</head>

<body>
  <div class="card">
    <h2>ğŸ¤ ã‚­ãƒ¼èª¿æ•´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé€Ÿåº¦ãã®ã¾ã¾ï¼‰</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
    </div>
    <p class="hint">
      â€» iPhoneã¯ã€ã¾ãšã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†ç”Ÿã™ã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚<br>
      â€» ã‚­ãƒ¼å¤‰æ›´ã¯éŸ³è³ªãŒå°‘ã—åŠ£åŒ–ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼ˆã‚«ãƒ©ã‚ªã‚±ã¨åŒã˜ï¼‰ã€‚
    </p>

    <div class="row" style="margin-top:10px;">
      <button id="playBtn" class="disabled">â–¶ å†ç”Ÿ</button>
      <button id="pauseBtn" class="disabled">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="stopBtn" class="disabled">â¹ åœæ­¢</button>
    </div>

    <h3 style="margin-top:18px;">ã‚­ãƒ¼ï¼ˆåŠéŸ³ï¼‰</h3>
    <input type="range" id="key" min="-12" max="12" step="1" value="0" class="disabled" />
    <div class="big"><span id="keyValue">0</span></div>

    <div style="margin-top:12px;">
      <input type="range" id="pos" min="0" max="0" step="0.01" value="0" class="disabled" />
      <div class="hint"><span id="timeText">0:00 / 0:00</span></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const loadBtn   = document.getElementById('loadBtn');

    const playBtn  = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn  = document.getElementById('stopBtn');

    const key      = document.getElementById('key');
    const keyValue = document.getElementById('keyValue');

    const pos      = document.getElementById('pos');
    const timeText = document.getElementById('timeText');

    let player = null;
    let pitchShift = null;

    let blobUrl = null;
    let isLoaded = false;
    let isPlaying = false;

    let pauseOffset = 0;   // ç§’
    let startedAt = 0;     // Tone.now() ã®æ™‚åˆ»
    let duration = 0;

    function enable(el, on) {
      el.classList.toggle('disabled', !on);
    }
    function fmt(sec){
      sec = Math.max(0, sec);
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,'0')}`;
    }
    function currentTime(){
      if (!isLoaded) return 0;
      if (!isPlaying) return pauseOffset;
      return pauseOffset + (Tone.now() - startedAt);
    }
    function updateUI(){
      if (!isLoaded) {
        timeText.textContent = "0:00 / 0:00";
        return;
      }
      const t = Math.min(currentTime(), duration);
      pos.value = t;
      timeText.textContent = `${fmt(t)} / ${fmt(duration)}`;

      // çµ‚äº†åˆ¤å®šï¼ˆå†ç”ŸãŒçµ‚ã‚ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆï¼‰
      if (isPlaying && t >= duration - 0.02) {
        stop();
      }
      requestAnimationFrame(updateUI);
    }

    async function initChain(url){
      // iOSç­‰ã®è‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾ç­–ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…ã§ AudioContext ã‚’é–‹å§‹
      await Tone.start();

      // æ—¢å­˜ã‚’ç ´æ£„
      try { if (player) player.dispose(); } catch(e){}
      try { if (pitchShift) pitchShift.dispose(); } catch(e){}

      pitchShift = new Tone.PitchShift({ pitch: Number(key.value) }).toDestination();
      player = new Tone.Player({
        url,
        autostart: false
      }).connect(pitchShift);

      await player.load(url);
      duration = player.buffer ? player.buffer.duration : 0;

      pauseOffset = 0;
      isPlaying = false;

      pos.max = duration.toFixed(2);
      pos.value = "0";

      isLoaded = true;

      enable(playBtn, true);
      enable(pauseBtn, true);
      enable(stopBtn, true);
      enable(key, true);
      enable(pos, true);

      requestAnimationFrame(updateUI);
    }

    function play(){
      if (!isLoaded || isPlaying) return;

      const offset = Math.min(pauseOffset, Math.max(0, duration - 0.01));
      player.start(undefined, offset);
      startedAt = Tone.now();
      isPlaying = true;
    }

    function pause(){
      if (!isLoaded || !isPlaying) return;

      pauseOffset = Math.min(currentTime(), duration);
      player.stop();
      isPlaying = false;
    }

    function stop(){
      if (!isLoaded) return;

      try { player.stop(); } catch(e){}
      pauseOffset = 0;
      isPlaying = false;
      pos.value = "0";
    }

    loadBtn.addEventListener('click', async () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }

      if (blobUrl) URL.revokeObjectURL(blobUrl);
      blobUrl = URL.createObjectURL(f);

      try{
        await initChain(blobUrl);
      }catch(err){
        console.error(err);
        alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å½¢å¼ï¼ˆmp3/wavãªã©ï¼‰ã§è©¦ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    playBtn.addEventListener('click', play);
    pauseBtn.addEventListener('click', pause);
    stopBtn.addEventListener('click', stop);

    key.addEventListener('input', () => {
      keyValue.textContent = `${Number(key.value) >= 0 ? '+' : ''}${key.value}`;
      if (pitchShift) pitchShift.pitch = Number(key.value); // åŠéŸ³
    });
    key.dispatchEvent(new Event('input'));

    // ä½ç½®å¤‰æ›´ï¼ˆã‚·ãƒ¼ã‚¯ï¼‰
    let seeking = false;
    pos.addEventListener('input', () => { seeking = true; });
    pos.addEventListener('change', () => {
      if (!isLoaded) return;
      const newT = Number(pos.value);
      pauseOffset = Math.min(Math.max(newT, 0), duration);

      if (isPlaying) {
        // å†ç”Ÿä¸­ãªã‚‰ãã®ä½ç½®ã‹ã‚‰å†é–‹
        try { player.stop(); } catch(e){}
        player.start(undefined, pauseOffset);
        startedAt = Tone.now();
      }
      seeking = false;
    });
  </script>
</body>
</html>


