<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Practice Player</title>
</head>

<body>

<h2>キー変更プレイヤー</h2>

<input type="file" id="file"><br><br>

<button id="playBtn">再生</button>
<button onclick="stop()">停止</button>

<h3>キー</h3>
<button onclick="pitchDown()">−</button>
<span id="pitchVal">0</span>
<button onclick="pitchUp()">＋</button>

<script src="https://cdn.jsdelivr.net/npm/soundtouchjs@0.1.30/dist/soundtouch.min.js"></script>

<script>
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let buffer;
let pitch = 0;
let source;

document.getElementById("file").onchange = async e=>{
    const arr = await e.target.files[0].arrayBuffer();
    buffer = await audioCtx.decodeAudioData(arr);
};

document.getElementById("playBtn").onclick = async ()=>{
    if(!buffer) return;

    await audioCtx.resume(); // Safari対策

    stop();

    const st = new soundtouch.SoundTouch(audioCtx.sampleRate);
    st.pitch = Math.pow(2, pitch/12);

    const src = audioCtx.createBufferSource();
    src.buffer = buffer;

    const node = soundtouch.getWebAudioNode(audioCtx, src, st);
    node.connect(audioCtx.destination);

    src.start(0);
    source = src;
};

function stop(){
    if(source) source.stop();
}

function pitchUp(){
    pitch++;
    document.getElementById("pitchVal").innerText = pitch;
}
function pitchDown(){
    pitch--;
    document.getElementById("pitchVal").innerText = pitch;
}
</script>

</body>
</html>
