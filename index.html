<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Practice Player</title>

  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
    .card{background:white;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);max-width:640px;margin:0 auto;}
    input[type=range]{width:100%;}
    button{padding:10px 16px;margin:6px;font-size:15px;}
    .big{font-size:18px;font-weight:bold;}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
    .hint{font-size:12px;color:#555;line-height:1.4;margin:8px 0 0;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>

  <!-- SoundTouchJSï¼ˆãƒ”ãƒƒãƒã ã‘å¤‰æ›´ï¼‰ -->
  <script src="https://unpkg.com/soundtouchjs/dist/soundtouch.min.js"></script>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ ç·´ç¿’ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
    </div>
    <p class="hint">
      â€» iPhoneã¯ã€Œèª­ã¿è¾¼ã¿ã€â†’ã€Œå†ç”Ÿã€ã®é †ãŒå®‰å®šã—ã¾ã™ã€‚<br>
      â€» ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ (PWA)ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®æ™‚ã¯Safariã§é–‹ã„ã¦ãã ã•ã„ã€‚
    </p>

    <h3>å†ç”Ÿ</h3>
    <div class="row">
      <button id="playBtn">â–¶ å†ç”Ÿ</button>
      <button id="pauseBtn">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="stopBtn">â¹ åœæ­¢</button>
    </div>

    <div style="margin-top:10px;">
      <input type="range" id="seek" min="0" max="1000" step="1" value="0" />
      <div class="row" style="justify-content:space-between;">
        <span class="mono" id="timeNow">00:00.0</span>
        <span class="mono" id="timeTotal">00:00.0</span>
      </div>
    </div>

    <h3>ãƒ”ãƒƒãƒï¼ˆé€Ÿåº¦å›ºå®š 1.0ï¼‰</h3>
    <input type="range" id="pitch" min="-24" max="24" step="1" value="0" />
    <p class="big" id="pitchValue">0</p>
    <p class="hint">å˜ä½ï¼šåŠéŸ³ï¼ˆ-24ã€œ+24ï¼‰</p>

    <h3>A-Bãƒ«ãƒ¼ãƒ—</h3>
    <div class="row">
      <button id="setABtn">Aè¨­å®š</button>
      <button id="setBBtn">Bè¨­å®š</button>
      <button id="clearLoopBtn">è§£é™¤</button>
    </div>
    <p id="loopStatus">æœªè¨­å®š</p>

    <h3>10ç§’æˆ»ã‚‹ / é€²ã‚€</h3>
    <div class="row">
      <button id="back10">â—€ 10ç§’</button>
      <button id="fwd10">10ç§’ â–¶</button>
    </div>
  </div>

  <script>
    // ---- DOM ----
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');

    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');

    const pitch = document.getElementById('pitch');
    const pitchValue = document.getElementById('pitchValue');

    const seek = document.getElementById('seek');
    const timeNow = document.getElementById('timeNow');
    const timeTotal = document.getElementById('timeTotal');

    const loopStatus = document.getElementById('loopStatus');
    const setABtn = document.getElementById('setABtn');
    const setBBtn = document.getElementById('setBBtn');
    const clearLoopBtn = document.getElementById('clearLoopBtn');

    const back10 = document.getElementById('back10');
    const fwd10 = document.getElementById('fwd10');

    // ---- Audio/Engine ----
    let ctx = null;
    let buffer = null;

    // SoundTouch objects
    let soundTouch = null;
    let source = null;
    let filter = null;
    let node = null;

    let isPlaying = false;
    let rafId = null;

    // position in seconds
    let posSec = 0;

    // A/B loop points in seconds
    let A = null;
    let B = null;

    function ensureContext() {
      if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      return ctx;
    }

    function fmtTime(sec) {
      sec = Math.max(0, sec);
      const m = Math.floor(sec / 60);
      const s = sec - m * 60;
      const mm = String(m).padStart(2, '0');
      const ss = String(Math.floor(s)).padStart(2, '0');
      const d = Math.floor((s - Math.floor(s)) * 10);
      return `${mm}:${ss}.${d}`;
    }

    function getDuration() {
      return buffer ? buffer.duration : 0;
    }

    function updateUI() {
      const dur = getDuration();
      timeNow.textContent = fmtTime(posSec);
      timeTotal.textContent = fmtTime(dur);

      if (dur > 0) {
        const v = Math.round((posSec / dur) * 1000);
        seek.value = String(Math.min(1000, Math.max(0, v)));
      } else {
        seek.value = "0";
      }
    }

    function setLoopStatusText() {
      if (A === null && B === null) { loopStatus.textContent = "æœªè¨­å®š"; return; }
      if (A !== null && B === null) { loopStatus.textContent = "A:" + A.toFixed(1); return; }
      if (A !== null && B !== null) { loopStatus.textContent = `A:${A.toFixed(1)} / B:${B.toFixed(1)}`; return; }
      loopStatus.textContent = "æœªè¨­å®š";
    }

    function pitchFactorFromSemitone(semi) {
      return Math.pow(2, semi / 12);
    }

    function buildEngine() {
      const ac = ensureContext();
      const st = window.soundtouch; // from soundtouch.min.js
      if (!st) {
        alert("SoundTouchJSã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªï¼‰");
        return false;
      }

      // SoundTouch setup
      soundTouch = new st.SoundTouch(ac.sampleRate);
      soundTouch.tempo = 1.0;               // é€Ÿåº¦å›ºå®š
      soundTouch.rate = 1.0;                // é€Ÿåº¦å›ºå®š
      soundTouch.pitch = pitchFactorFromSemitone(Number(pitch.value)); // ãƒ”ãƒƒãƒã®ã¿

      // Source for SoundTouch
      source = new st.WebAudioBufferSource(buffer);
      filter = new st.SimpleFilter(source, soundTouch);

      // ScriptProcessorï¼ˆäº’æ›æ€§é‡è¦–ã€‚å°†æ¥ã¯AudioWorkletæ¨å¥¨ï¼‰
      const bufferSize = 2048;
      node = ac.createScriptProcessor(bufferSize, 2, 2);

      node.onaudioprocess = (e) => {
        if (!isPlaying) {
          // silence
          e.outputBuffer.getChannelData(0).fill(0);
          e.outputBuffer.getChannelData(1).fill(0);
          return;
        }

        const outL = e.outputBuffer.getChannelData(0);
        const outR = e.outputBuffer.getChannelData(1);

        const frames = filter.extract([outL, outR], outL.length);

        // çµ‚ç«¯ã¾ã§è¡Œã£ãŸã‚‰åœæ­¢
        if (frames === 0) {
          stopPlayback();
          return;
        }

        // position æ›´æ–°ï¼ˆsource.position ã¯ "samples" ãªã®ã§ç§’ã¸ï¼‰
        posSec = source.position / ac.sampleRate;

        // A-Bãƒ«ãƒ¼ãƒ—
        if (A !== null && B !== null && posSec >= B) {
          seekTo(A);
        }

        // ä½™ã£ãŸåˆ†ã‚’ç„¡éŸ³
        if (frames < outL.length) {
          outL.fill(0, frames);
          outR.fill(0, frames);
        }
      };

      node.connect(ac.destination);
      return true;
    }

    function destroyEngine() {
      if (node) { try { node.disconnect(); } catch(_){} }
      node = null;
      filter = null;
      source = null;
      soundTouch = null;
    }

    function startPlayback() {
      if (!buffer) { alert("å…ˆã«éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„"); return; }
      const ac = ensureContext();
      ac.resume(); // iOSå¯¾ç­–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§èµ·ã“ã™ï¼‰

      if (!node) {
        if (!buildEngine()) return;
      }

      isPlaying = true;
      tick();
    }

    function pausePlayback() {
      isPlaying = false;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      updateUI();
    }

    function stopPlayback() {
      isPlaying = false;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      posSec = 0;
      if (source && ctx) source.position = 0;
      updateUI();
    }

    function seekTo(sec) {
      if (!buffer || !ctx || !source) { posSec = sec; updateUI(); return; }
      const dur = getDuration();
      const clamped = Math.min(dur, Math.max(0, sec));
      posSec = clamped;
      source.position = Math.floor(clamped * ctx.sampleRate);
      updateUI();
    }

    function tick() {
      updateUI();
      rafId = requestAnimationFrame(tick);
    }

    // ---- File load ----
    async function loadSelectedFile() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { alert("éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

      const ac = ensureContext();
      await ac.resume();

      const arr = await f.arrayBuffer();
      buffer = await ac.decodeAudioData(arr);

      // reset state
      posSec = 0;
      A = null; B = null;
      setLoopStatusText();
      updateUI();

      // rebuild engine with new buffer
      destroyEngine();
      buildEngine();

      alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
    }

    // ---- Events ----
    loadBtn.addEventListener('click', loadSelectedFile);

    pitch.addEventListener('input', () => {
      const v = Number(pitch.value);
      pitchValue.textContent = String(v);
      if (soundTouch) {
        soundTouch.pitch = pitchFactorFromSemitone(v); // ãƒ”ãƒƒãƒã®ã¿å¤‰æ›´
      }
    });

    playBtn.addEventListener('click', startPlayback);
    pauseBtn.addEventListener('click', pausePlayback);
    stopBtn.addEventListener('click', stopPlayback);

    seek.addEventListener('input', () => {
      const dur = getDuration();
      if (!dur) return;
      const sec = (Number(seek.value) / 1000) * dur;
      seekTo(sec);
    });

    setABtn.addEventListener('click', () => {
      A = posSec;
      setLoopStatusText();
    });

    setBBtn.addEventListener('click', () => {
      if (A === null) { alert("å…ˆã«Aã‚’è¨­å®šã—ã¦ãã ã•ã„"); return; }
      B = posSec;
      if (B <= A) { alert("Bã¯Aã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„"); B = null; }
      setLoopStatusText();
    });

    clearLoopBtn.addEventListener('click', () => {
      A = null; B = null;
      setLoopStatusText();
    });

    function skip(sec) {
      seekTo(posSec + sec);
    }
    back10.addEventListener('click', () => skip(-10));
    fwd10.addEventListener('click', () => skip(10));

    // åˆæœŸè¡¨ç¤º
    pitchValue.textContent = "0";
    updateUI();
    setLoopStatusText();
  </script>
</body>
</html>
