<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Practice Player</title>

  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
    .card{background:white;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);max-width:680px;margin:0 auto;}
    input[type=range]{width:100%;}
    button{padding:10px 16px;margin:6px;font-size:15px;}
    .big{font-size:18px;font-weight:bold;}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;align-items:center;}
    .hint{font-size:12px;color:#555;line-height:1.5;text-align:left;margin:10px auto 0;max-width:620px;}
    .kbd{display:inline-block;border:1px solid #ccc;border-bottom-width:2px;border-radius:6px;padding:2px 8px;margin:2px 3px;background:#fafafa;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;}
    .sep{height:1px;background:#eee;margin:14px 0;}
    .status{font-size:13px;color:#333;margin-top:6px;}
    .muted{color:#666;}
    .danger{color:#b00020;}
  </style>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ ç·´ç¿’ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚­ãƒ¼å®Œå…¨ç‰ˆï¼‰</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
      <button id="helpBtn" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¡¨ç¤ºåˆ‡æ›¿">ã‚­ãƒ¼ä¸€è¦§</button>
    </div>

    <div class="hint">
      <div class="muted">
        â€» iPhoneã¯ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†ç”Ÿã™ã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚<br>
        â€» iPhoneã®ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ (PWA)ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®æ™‚ã¯Safariã§é–‹ã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <audio id="audio" controls playsinline></audio>

    <div class="sep"></div>

    <h3>å†ç”Ÿé€Ÿåº¦ï¼ˆãƒ”ãƒƒãƒç¶­æŒï¼‰</h3>
    <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1" />
    <p class="big" id="speedValue">1.00x</p>

    <div class="sep"></div>

    <h3>A-Bãƒ«ãƒ¼ãƒ—</h3>
    <div class="row">
      <button id="setABtn">Aè¨­å®š</button>
      <button id="setBBtn">Bè¨­å®š</button>
      <button id="toggleLoopBtn">ãƒ«ãƒ¼ãƒ—ON/OFF</button>
      <button id="clearLoopBtn">è§£é™¤</button>
    </div>
    <p class="status" id="loopStatus">æœªè¨­å®š</p>

    <div class="sep"></div>

    <h3>ã‚¹ã‚­ãƒƒãƒ—</h3>
    <div class="row">
      <button id="back10">â—€ 10ç§’</button>
      <button id="back5">â—€ 5ç§’</button>
      <button id="fwd5">5ç§’ â–¶</button>
      <button id="fwd10">10ç§’ â–¶</button>
    </div>

    <div class="sep"></div>

    <div id="help" class="hint" style="display:none;">
      <b>âŒ¨ï¸ ã‚­ãƒ¼æ“ä½œï¼ˆå®Œå…¨ç‰ˆï¼‰</b><br>
      <span class="kbd">Space</span> å†ç”Ÿ/åœæ­¢ã€€
      <span class="kbd">â†</span>/<span class="kbd">â†’</span> 5ç§’æˆ»ã‚‹/é€²ã‚€ã€€
      <span class="kbd">Shift</span>+<span class="kbd">â†</span>/<span class="kbd">â†’</span> 10ç§’æˆ»ã‚‹/é€²ã‚€<br>
      <span class="kbd">A</span> Aè¨­å®šã€€
      <span class="kbd">B</span> Bè¨­å®šã€€
      <span class="kbd">L</span> ãƒ«ãƒ¼ãƒ—ON/OFFã€€
      <span class="kbd">C</span> ãƒ«ãƒ¼ãƒ—è§£é™¤<br>
      <span class="kbd">+</span>/<span class="kbd">-</span> é€Ÿåº¦ +0.05 / -0.05ã€€
      <span class="kbd">0</span> é€Ÿåº¦1.00ã«æˆ»ã™ã€€
      <span class="kbd">H</span> ã‚­ãƒ¼ä¸€è¦§ã®è¡¨ç¤ºåˆ‡æ›¿
      <div class="muted" style="margin-top:6px;">
        â€» å…¥åŠ›æ¬„ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç­‰ï¼‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹ã¨ãã¯ã‚­ãƒ¼æ“ä½œã‚’æŠ‘åˆ¶ã—ã¾ã™ã€‚
      </div>
    </div>
  </div>

  <script>
    const audio = document.getElementById('audio');
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');

    const speed = document.getElementById('speed');
    const speedValue = document.getElementById('speedValue');

    const loopStatus = document.getElementById('loopStatus');
    const setABtn = document.getElementById('setABtn');
    const setBBtn = document.getElementById('setBBtn');
    const toggleLoopBtn = document.getElementById('toggleLoopBtn');
    const clearLoopBtn = document.getElementById('clearLoopBtn');

    const back10 = document.getElementById('back10');
    const back5 = document.getElementById('back5');
    const fwd5 = document.getElementById('fwd5');
    const fwd10 = document.getElementById('fwd10');

    const help = document.getElementById('help');
    const helpBtn = document.getElementById('helpBtn');

    let A = null;
    let B = null;
    let loopEnabled = true;
    let blobUrl = null;

    function clampTime(t) {
      const d = Number.isFinite(audio.duration) ? audio.duration : 0;
      if (!d) return Math.max(0, t);
      return Math.min(Math.max(0, t), Math.max(0, d - 0.01));
    }

    function setPreservePitch() {
      // ãƒ–ãƒ©ã‚¦ã‚¶å·®ç•°å¸åï¼ˆå¯¾å¿œã—ã¦ãªã„ç’°å¢ƒã§ã‚‚è½ã¡ãªã„ï¼‰
      try { audio.preservesPitch = true; } catch(e) {}
      try { audio.webkitPreservesPitch = true; } catch(e) {}
    }

    function updateSpeedUI() {
      speedValue.innerText = Number(speed.value).toFixed(2) + 'x';
    }

    function updateLoopStatus() {
      if (A === null && B === null) {
        loopStatus.textContent = 'æœªè¨­å®š';
        loopStatus.className = 'status';
        return;
      }
      const parts = [];
      if (A !== null) parts.push('A:' + A.toFixed(1));
      if (B !== null) parts.push('B:' + B.toFixed(1));
      parts.push(loopEnabled ? 'ï¼ˆãƒ«ãƒ¼ãƒ—ONï¼‰' : 'ï¼ˆãƒ«ãƒ¼ãƒ—OFFï¼‰');
      loopStatus.textContent = parts.join(' / ');
      loopStatus.className = 'status';
      if (A !== null && B !== null && B <= A) loopStatus.classList.add('danger');
    }

    function loadSelectedFile() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
      }
      if (blobUrl) URL.revokeObjectURL(blobUrl);
      blobUrl = URL.createObjectURL(f);
      audio.src = blobUrl;
      audio.load(); // iOSç³»ã§å®‰å®š
      setPreservePitch();

      // ãƒ«ãƒ¼ãƒ—çŠ¶æ…‹ã¯ãƒªã‚»ãƒƒãƒˆ
      A = null; B = null; loopEnabled = true;
      updateLoopStatus();
    }

    function togglePlay() {
      if (!audio.src) {
        alert('å…ˆã«éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        return;
      }
      if (audio.paused) audio.play();
      else audio.pause();
    }

    function skip(sec) {
      audio.currentTime = clampTime(audio.currentTime + sec);
    }

    function setA() {
      if (!audio.src) { alert('å…ˆã«éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
      A = audio.currentTime;
      // Aã‚’æ›´æ–°ã—ãŸã‚‰ã€BãŒAã‚ˆã‚Šå‰ãªã‚‰ç„¡åŠ¹åŒ–
      if (B !== null && B <= A) B = null;
      updateLoopStatus();
    }

    function setB() {
      if (!audio.src) { alert('å…ˆã«éŸ³æºã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
      if (A === null) { alert('å…ˆã«Aã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
      B = audio.currentTime;
      if (B <= A) {
        alert('Bã¯Aã‚ˆã‚Šå¾Œã‚ã«è¨­å®šã—ã¦ãã ã•ã„');
        B = null;
      }
      updateLoopStatus();
    }

    function clearLoop() {
      A = null; B = null;
      loopEnabled = true;
      updateLoopStatus();
    }

    function toggleLoop() {
      loopEnabled = !loopEnabled;
      updateLoopStatus();
    }

    function setSpeed(v) {
      const nv = Math.min(1.5, Math.max(0.5, v));
      speed.value = nv.toFixed(2);
      audio.playbackRate = Number(speed.value);
      setPreservePitch();
      updateSpeedUI();
    }

    function nudgeSpeed(delta) {
      setSpeed(Number(speed.value) + delta);
    }

    function toggleHelp() {
      help.style.display = (help.style.display === 'none') ? 'block' : 'none';
    }

    // UI events
    loadBtn.addEventListener('click', loadSelectedFile);
    fileInput.addEventListener('change', () => {
      // å¤‰ãˆãŸã‚‰çŠ¶æ…‹ã ã‘æ›´æ–°ï¼ˆèª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³æ–¹å¼ãŒå®‰å®šï¼‰
      A = null; B = null; loopEnabled = true;
      updateLoopStatus();
    });

    speed.addEventListener('input', () => {
      audio.playbackRate = Number(speed.value);
      setPreservePitch();
      updateSpeedUI();
    });

    setABtn.addEventListener('click', setA);
    setBBtn.addEventListener('click', setB);
    clearLoopBtn.addEventListener('click', clearLoop);
    toggleLoopBtn.addEventListener('click', toggleLoop);

    back10.addEventListener('click', () => skip(-10));
    back5.addEventListener('click', () => skip(-5));
    fwd5.addEventListener('click', () => skip(5));
    fwd10.addEventListener('click', () => skip(10));

    helpBtn.addEventListener('click', toggleHelp);

    // AB loop core
    audio.addEventListener('timeupdate', () => {
      if (!loopEnabled) return;
      if (A !== null && B !== null && B > A) {
        if (audio.currentTime >= B) {
          audio.currentTime = A;
        }
      }
    });

    // Keyboard shortcuts (å®Œå…¨ç‰ˆ)
    document.addEventListener('keydown', (e) => {
      // å…¥åŠ›ä¸­ã¯é‚ªé­”ã—ãªã„
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : '';
      const isTyping = tag === 'input' || tag === 'textarea' || document.activeElement?.isContentEditable;
      if (isTyping) return;

      // ä¿®é£¾ã‚­ãƒ¼ï¼ˆCtrl/Meta/Altï¼‰ã¯åŸºæœ¬ç„¡è¦–ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
      if (e.ctrlKey || e.metaKey || e.altKey) return;

      const key = e.key;

      // Space: play/pause
      if (key === ' ') {
        e.preventDefault();
        togglePlay();
        return;
      }

      // Help toggle
      if (key === 'h' || key === 'H') {
        toggleHelp();
        return;
      }

      // Skip
      if (key === 'ArrowLeft') {
        e.preventDefault();
        skip(e.shiftKey ? -10 : -5);
        return;
      }
      if (key === 'ArrowRight') {
        e.preventDefault();
        skip(e.shiftKey ? 10 : 5);
        return;
      }

      // Loop controls
      if (key === 'a' || key === 'A') { setA(); return; }
      if (key === 'b' || key === 'B') { setB(); return; }
      if (key === 'l' || key === 'L') { toggleLoop(); return; }
      if (key === 'c' || key === 'C') { clearLoop(); return; }

      // Speed controls
      if (key === '+' || key === '=') { // USé…åˆ—ã§+ãŒ=ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
        e.preventDefault();
        nudgeSpeed(0.05);
        return;
      }
      if (key === '-' || key === '_') {
        e.preventDefault();
        nudgeSpeed(-0.05);
        return;
      }
      if (key === '0') {
        e.preventDefault();
        setSpeed(1.0);
        return;
      }
    });

    // init
    setPreservePitch();
    updateSpeedUI();
    updateLoopStatus();
  </script>
</body>
</html>
