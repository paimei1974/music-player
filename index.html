<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Practice Player</title>

<style>
body{font-family:sans-serif;text-align:center;padding:20px;background:#f5f6fa;}
.card{background:white;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.1);max-width:600px;margin:auto;}
button{padding:10px 16px;margin:6px;}
input[type=range]{width:100%;}
</style>
</head>

<body>
<div class="card">
<h2>練習用プレイヤー（キー変更対応）</h2>

<input type="file" id="file"><br><br>

<button onclick="play()">再生</button>
<button onclick="stop()">停止</button>

<h3>キー変更</h3>
<button onclick="pitchDown()">−</button>
<span id="pitchVal">0</span>
<button onclick="pitchUp()">＋</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/soundtouchjs@0.1.30/dist/soundtouch.min.js"></script>

<script>
let audioCtx;
let buffer;
let pitch = 0;
let source;

document.getElementById("file").onchange = async e=>{
    const file = e.target.files[0];
    audioCtx = new AudioContext();
    const arr = await file.arrayBuffer();
    buffer = await audioCtx.decodeAudioData(arr);
};

function play(){
    if(!buffer) return;
    stop();

    const st = new soundtouch.SoundTouch(audioCtx.sampleRate);
    st.pitch = Math.pow(2, pitch/12);

    const src = audioCtx.createBufferSource();
    src.buffer = buffer;

    const node = soundtouch.getWebAudioNode(audioCtx, src, st);
    node.connect(audioCtx.destination);

    src.start(0);
    source = src;
}

function stop(){
    if(source) source.stop();
}

function pitchUp(){
    pitch++;
    document.getElementById("pitchVal").innerText = pitch;
}

function pitchDown(){
    pitch--;
    document.getElementById("pitchVal").innerText = pitch;
}
</script>
</body>
</html>
