<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Practice Player</title>

  <style>
    :root{
      --bg:#f5f6fa;
      --card:#fff;
      --text:#111;
      --muted:#555;
      --line:rgba(0,0,0,.08);
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:14px;
    }
    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      text-align:center;
      padding:18px;
      background:var(--bg);
      color:var(--text);
      margin:0;
    }
    .card{
      background:var(--card);
      padding:18px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-width:640px;
      margin:0 auto;
      border:1px solid var(--line);
    }
    h2{ margin:4px 0 10px; }
    h3{ margin:18px 0 8px; font-size:16px; }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center; }
    .row.tight{ gap:8px; }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin:8px 0 0;
      text-align:left;
    }
    input[type="range"]{ width:100%; }
    button{
      padding:10px 14px;
      margin:0;
      font-size:15px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{ font-weight:700; }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    .big{ font-size:18px; font-weight:800; margin:8px 0 0; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      background:#fff;
    }
    .status{
      margin:10px 0 0;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      border-top:1px solid var(--line);
      padding-top:10px;
    }
    .status .left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum"; }
    .sep{ height:1px; background:var(--line); margin:14px 0; }
    audio{ width:100%; margin-top:10px; }
    .small{ font-size:12px; color:var(--muted); margin:6px 0 0; text-align:left; }
    .kbd{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:#fff; }
  </style>
</head>

<body>
  <div class="card">
    <h2>ğŸ¸ ç·´ç¿’ç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

    <div class="row">
      <input type="file" id="fileInput" accept="audio/*" />
      <button id="loadBtn" class="primary">èª­ã¿è¾¼ã¿</button>
    </div>

    <p class="hint">
      â–  iPhoneå¯¾ç­–<br>
      ãƒ»ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†ç”Ÿã™ã‚‹ã¨å®‰å®šã—ã‚„ã™ã„ã§ã™ã€‚<br>
      ãƒ»ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ï¼ˆPWAï¼‰ã ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒå‹•ã‹ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®æ™‚ã¯Safariã§é–‹ã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚<br>
      ãƒ»å†ç”ŸãŒç„¡éŸ³/æ­¢ã¾ã‚‹æ™‚ã¯ä¸€åº¦ã€Œâ–¶ï¸å†ç”Ÿâ†’â¸åœæ­¢ã€ã‚’ã—ã¦ã‹ã‚‰æ“ä½œã™ã‚‹ã¨ç›´ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼ˆiOSã®åˆ¶é™ï¼‰ã€‚
    </p>

    <audio id="audio" controls playsinline></audio>

    <div class="status">
      <div class="left">
        <span class="pill mono" id="timeText">00:00 / 00:00</span>
        <span class="pill mono" id="rateText">Rate: 1.00x</span>
        <span class="pill mono" id="loopText">Loop: Off</span>
      </div>
      <div class="right">
        <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div class="sep"></div>

    <h3>å†ç”Ÿé€Ÿåº¦ï¼ˆãƒ”ãƒƒãƒç¶­æŒï¼‰</h3>
    <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1" />
    <p class="big mono" id="speedValue">1.00x</p>
    <p class="small">
      â€»ã€Œãƒ”ãƒƒãƒç¶­æŒã€ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã§ã™ã€‚iPhone/Safariã¯ <span class="kbd">preservesPitch</span> ãŒåŠ¹ãã“ã¨ãŒå¤šã„ã§ã™ãŒã€çŠ¶æ³ã«ã‚ˆã‚Šå¤‰ã‚ã‚Šã¾ã™ã€‚
    </p>

    <h3>A-Bãƒ«ãƒ¼ãƒ—</h3>
    <div class="row tight">
      <button id="setABtn">Aè¨­å®š</button>
      <button id="setBBtn">Bè¨­å®š</button>
      <button id="toggleLoopBtn">ãƒ«ãƒ¼ãƒ—ON/OFF</button>
      <button id="clearLoopBtn">è§£é™¤</button>
    </div>
    <p class="mono" id="loopStatus">æœªè¨­å®š</p>

    <h3>10ç§’æˆ»ã‚‹ / é€²ã‚€</h3>
    <div class="row tight">
      <button id="back10">â—€ 10ç§’</button>
      <button id="fwd10">10ç§’ â–¶</button>
    </div>

    <h3>å°åˆ»ã¿</h3>
    <div class="row tight">
      <button data-skip="-1">â—€ 1ç§’</button>
      <button data-skip="1">1ç§’ â–¶</button>
      <button data-skip="-3">â—€ 3ç§’</button>
      <button data-skip="3">3ç§’ â–¶</button>
    </div>

    <div class="sep"></div>
    <p class="small">
      ä½¿ã„æ–¹ï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ã€Œèª­ã¿è¾¼ã¿ã€â†’å†ç”Ÿ â†’ Aè¨­å®š â†’ Bè¨­å®š â†’ ãƒ«ãƒ¼ãƒ—ON/OFF<br>
      â€»Bã¯Aã‚ˆã‚Šå¾Œã‚ã§è¨­å®šã—ã¦ãã ã•ã„ï¼ˆé€†ã ã¨è­¦å‘Šã—ã¾ã™ï¼‰ã€‚
    </p>
  </div>

  <script>
    const audio = document.getElementById('audio');
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');

    const speed = document.getElementById('speed');
    const speedValue = document.getElementById('speedValue');

    const timeText = document.getElementById('timeText');
    const rateText = document.getElementById('rateText');
    const loopText = document.getElementById('loopText');

    const loopStatus = document.getElementById('loopStatus');
    const setABtn = document.getElementById('setABtn');
    const setBBtn = document.getElementById('setBBtn');
    const toggleLoopBtn = document.getElementById('toggleLoopBtn');
    const clearLoopBtn = document.getElementById('clearLoopBtn');

    const back10 = document.getElementById('back10');
    const fwd10 = document.getElementById('fwd10');
    const resetBtn = document.getElementById('resetBtn');

    let A = null;
    let B = null;
    let loopEnabled = false;
    let blobUrl = null;

    // ---------- utilities ----------
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function formatTime(sec){
      if (!isFinite(sec)) return "00:00";
      sec = Math.max(0, sec);
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
    }

    function updateTimeUI(){
      const cur = audio.currentTime || 0;
      const dur = audio.duration || 0;
      timeText.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
    }

    function setPreservePitch(){
      // ãƒ–ãƒ©ã‚¦ã‚¶å·®ç•°å¸åï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã‚‚ã‚ã‚‹ã®ã§ tryï¼‰
      try { audio.preservesPitch = true; } catch(e) {}
      try { audio.webkitPreservesPitch = true; } catch(e) {}
      try { audio.mozPreservesPitch = true; } catch(e) {}
    }

    function setButtonsEnabled(enabled){
      setABtn.disabled = !enabled;
      setBBtn.disabled = !enabled;
      toggleLoopBtn.disabled = !enabled;
      clearLoopBtn.disabled = !enabled;
      back10.disabled = !enabled;
      fwd10.disabled = !enabled;
      document.querySelectorAll('button[data-skip]').forEach(b => b.disabled = !enabled);
    }

    function updateLoopUI(){
      if (A === null && B === null){
        loopStatus.textContent = "æœªè¨­å®š";
      } else if (A !== null && B === null){
        loopStatus.textContent = `A: ${A.toFixed(1)}sï¼ˆBæœªè¨­å®šï¼‰`;
      } else {
        loopStatus.textContent = `A: ${A.toFixed(1)}s / B: ${B.toFixed(1)}s`;
      }
      loopText.textContent = `Loop: ${loopEnabled ? "On" : "Off"}`;
    }

    function resetLoop(){
      A = null; B = null; loopEnabled = false;
      updateLoopUI();
    }

    // ---------- file load ----------
    function loadSelectedFile(){
      const f = fileInput.files && fileInput.files[0];
      if (!f){
        alert('éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
      }

      // å¤ã„ blob URL è§£æ”¾
      if (blobUrl) URL.revokeObjectURL(blobUrl);
      blobUrl = URL.createObjectURL(f);

      audio.src = blobUrl;
      audio.load();           // iOSã®ã€Œå…ˆã«é€²ã¾ãªã„ã€å¯¾ç­–
      setPreservePitch();

      // UI åˆæœŸåŒ–
      speed.value = "1";
      audio.playbackRate = 1;
      speedValue.textContent = "1.00x";
      rateText.textContent = "Rate: 1.00x";
      resetLoop();
      updateTimeUI();

      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
      //ï¼ˆduration ãŒå–ã‚Œãªã„æ™‚ã¯ loadeddata ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    }

    loadBtn.addEventListener('click', loadSelectedFile);

    fileInput.addEventListener('change', () => {
      // ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã¯ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ç¢ºå®š
      setButtonsEnabled(false);
      resetLoop();
      updateTimeUI();
    });

    audio.addEventListener('loadedmetadata', () => {
      setButtonsEnabled(true);
      updateTimeUI();
    });

    audio.addEventListener('loadeddata', () => {
      // loadedmetadata ãŒæ¥ãªã„ç’°å¢ƒç”¨
      setButtonsEnabled(true);
      updateTimeUI();
    });

    audio.addEventListener('error', () => {
      setButtonsEnabled(false);
      alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®éŸ³æºã§è©¦ã—ã¦ãã ã•ã„ã€‚');
    });

    // ---------- speed ----------
    speed.addEventListener('input', () => {
      const v = Number(speed.value);
      audio.playbackRate = v;
      setPreservePitch();
      speedValue.textContent = v.toFixed(2) + "x";
      rateText.textContent = "Rate: " + v.toFixed(2) + "x";
    });

    // ---------- AB loop ----------
    setABtn.addEventListener('click', () => {
      if (!isFinite(audio.currentTime)) return;
      A = audio.currentTime;
      if (B !== null && B <= A) {
        // Aã‚’å¾Œã‚ã«ç½®ã„ãŸã‚‰Bã‚’ã‚¯ãƒªã‚¢
        B = null;
        loopEnabled = false;
      }
      updateLoopUI();
    });

    setBBtn.addEventListener('click', () => {
      if (A === null) { alert('å…ˆã«Aã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
      if (!isFinite(audio.currentTime)) return;

      const t = audio.currentTime;
      if (t <= A + 0.05) { // ã»ã¼åŒã˜/é€†è»¢é˜²æ­¢
        alert('Bã¯Aã‚ˆã‚Šå¾Œã‚ã§è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }
      B = t;
      updateLoopUI();
    });

    toggleLoopBtn.addEventListener('click', () => {
      if (A === null || B === null){
        alert('Aã¨Bã‚’ä¸¡æ–¹è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }
      loopEnabled = !loopEnabled;
      updateLoopUI();
    });

    clearLoopBtn.addEventListener('click', () => {
      resetLoop();
    });

    // ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œï¼ˆtimeupdate ã¯ç²—ã„ã®ã§ã€å°‘ã—æ—©ã‚ã«æˆ»ã™ï¼‰
    audio.addEventListener('timeupdate', () => {
      updateTimeUI();

      if (!loopEnabled) return;
      if (A === null || B === null) return;

      const cur = audio.currentTime;
      // Bã«åˆ°é”ã—ãŸã‚‰Aã«æˆ»ã™
      if (cur >= B) {
        audio.currentTime = A;
        // iOSã§æ­¢ã¾ã‚‹äº‹ãŒã‚ã‚‹ã®ã§ã€å†ç”Ÿä¸­ãªã‚‰ç¶­æŒ
        if (!audio.paused) {
          // play() ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç„¡ã—ã ã¨æ‹’å¦ã•ã‚Œå¾—ã‚‹ãŒã€å†ç”Ÿä¸­ãªã‚‰é€šã‚‹ã“ã¨ãŒå¤šã„
          audio.play().catch(()=>{});
        }
      }
    });

    // ---------- skip ----------
    function skip(sec){
      if (!isFinite(audio.currentTime)) return;
      const dur = audio.duration;
      const next = audio.currentTime + sec;

      if (isFinite(dur)) {
        audio.currentTime = clamp(next, 0, Math.max(0, dur - 0.01));
      } else {
        audio.currentTime = Math.max(0, next);
      }
    }

    back10.addEventListener('click', () => skip(-10));
    fwd10.addEventListener('click', () => skip(10));
    document.querySelectorAll('button[data-skip]').forEach(b => {
      b.addEventListener('click', () => skip(Number(b.dataset.skip)));
    });

    // ---------- reset ----------
    resetBtn.addEventListener('click', () => {
      // é€Ÿåº¦ãƒ»ãƒ«ãƒ¼ãƒ—ãƒ»ä½ç½®ã‚’åˆæœŸåŒ–ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼‰
      audio.pause();
      audio.currentTime = 0;
      speed.value = "1";
      audio.playbackRate = 1;
      setPreservePitch();
      speedValue.textContent = "1.00x";
      rateText.textContent = "Rate: 1.00x";
      resetLoop();
      updateTimeUI();
    });

    // åˆæœŸçŠ¶æ…‹
    setButtonsEnabled(false);
    updateLoopUI();
    updateTimeUI();
  </script>
</body>
</html>
